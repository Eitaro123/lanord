<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã›ãªã„è¨­å®š -->
    <meta name="robots" content="noindex, nofollow">
    <title>ç ”ç©¶å®¤ åœ¨å¸­ç®¡ç†ãƒœãƒ¼ãƒ‰ (Online)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Cropper.js (ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°ç”¨) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®ã‚«ãƒ©ãƒ¼å®šç¾© */
        .status-present-bg { background-color: #dcfce7; color: #166534; border-left-color: #22c55e; }
        .status-experiment-bg { background-color: #fef9c3; color: #854d0e; border-left-color: #eab308; }
        .status-class-bg { background-color: #dbeafe; color: #1e40af; border-left-color: #3b82f6; }
        .status-meeting-bg { background-color: #f3e8ff; color: #6b21a8; border-left-color: #a855f7; }
        .status-absent-bg { background-color: #f8fafc; color: #64748b; border-left-color: #94a3b8; }

        /* --- 3Dãƒ•ãƒªãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        .flip-container {
            perspective: 1000px;
            height: 240px;
            cursor: pointer;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
        }
        
        .flip-container.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            top: 0; left: 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .flip-card-front {
            z-index: 2;
            transform: rotateY(0deg);
            border-left-width: 5px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .flip-container .flip-card-front:hover {
            transform: translateY(-3px) rotateY(0deg);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .flip-card-back {
            transform: rotateY(180deg);
            background-color: #ffffff;
            border: 2px solid #3b82f6;
            z-index: 1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³é¸æŠã‚¨ãƒªã‚¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š */
        .icon-scroll {
            cursor: grab;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .icon-scroll:active { cursor: grabbing; }
        .icon-scroll::-webkit-scrollbar { height: 2px; }
        .icon-scroll::-webkit-scrollbar-track { background: transparent; }
        .icon-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 30px;
            transform: translateX(-50%); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
        }

        /* Cropper Custom Style */
        .cropper-container { max-height: 60vh; }
        .cropper-view-box, .cropper-face { border-radius: 50%; }
        .cropper-dashed { display: none; }
    </style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-overlay" class="flex flex-col justify-center items-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-600 font-bold">ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</p>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-sm">
                    <i class="fa-solid fa-graduation-cap text-lg"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden md:block">è¿‘è—¤ç ”ç©¶å®¤ ãƒœãƒ¼ãƒ‰</h1>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight md:hidden">è¿‘è—¤ç ”ç©¶å®¤</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="window.promptRegisterDevice()" id="my-device-info" class="text-xs text-slate-500 hover:bg-slate-100 px-3 py-1.5 rounded-full border border-transparent hover:border-slate-200 flex items-center transition-colors">
                    <i class="fa-solid fa-mobile-screen-button mr-1.5"></i>
                    <span id="my-device-name" class="font-bold truncate max-w-[80px]">æœªè¨­å®š</span>
                </button>
                <div class="text-xl font-mono font-bold text-slate-700 w-14 text-right" id="current-clock">--:--</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-6xl">

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex bg-white p-1 rounded-lg shadow-sm border border-slate-200 w-full md:w-auto overflow-x-auto">
                <button onclick="window.setFilter('all')" id="filter-all" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-white bg-blue-600 shadow transition-all whitespace-nowrap">å…¨å“¡</button>
                <button onclick="window.setFilter('active')" id="filter-active" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all whitespace-nowrap">åœ¨å®¤ãƒ»å­¦å†…ã®ã¿</button>
                <button onclick="window.setFilter('absent')" id="filter-absent" class="filter-btn px-4 py-2 rounded-md text-sm font-bold text-slate-500 hover:bg-slate-100 transition-all whitespace-nowrap">ä¸åœ¨ãƒ»å¸°å®…</button>
            </div>

            <div class="flex space-x-2 w-full md:w-auto">
                <button onclick="window.toggleNfcPanel()" class="flex-1 md:flex-none flex items-center justify-center space-x-2 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2.5 rounded-lg font-bold shadow-sm transition-colors">
                    <i class="fa-solid fa-wifi rotate-90"></i>
                    <span class="hidden sm:inline">NFCã‚¿ã‚°ä½œæˆ</span>
                    <span class="sm:hidden">NFC</span>
                </button>
            </div>
        </div>

        <!-- åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ãƒœã‚¿ãƒ³ -->
        <div id="setup-area" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
            <h3 class="text-lg font-bold text-yellow-800 mb-2"><i class="fa-solid fa-database mr-2"></i>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã§ã™</h3>
            <p class="text-sm text-yellow-700 mb-4">åˆæœŸãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦åˆ©ç”¨ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ</p>
            <button id="btn-initialize-db" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded shadow">
                åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã™ã‚‹
            </button>
        </div>

        <!-- NFCãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div id="nfc-panel" class="hidden mb-8 animate-fade-in">
            <div class="bg-indigo-50 rounded-xl shadow-lg border border-indigo-200 overflow-hidden">
                <div class="bg-indigo-100 px-6 py-3 border-b border-indigo-200 flex justify-between items-center">
                    <h3 class="font-bold text-indigo-800"><i class="fa-solid fa-wifi rotate-90 mr-2"></i>NFCã‚¿ã‚° / QRã‚³ãƒ¼ãƒ‰ä½œæˆãƒ„ãƒ¼ãƒ«</h3>
                    <button onclick="window.toggleNfcPanel()" class="text-indigo-400 hover:text-indigo-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 mb-1">ã‚¿ã‚°ã®ç¨®é¡</label>
                                <div class="flex gap-2">
                                    <button onclick="window.setNfcMode('shared')" id="btn-mode-shared" class="flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600">ğŸ¢ å ´æ‰€ç”¨ (å…±æœ‰)</button>
                                    <button onclick="window.setNfcMode('personal')" id="btn-mode-personal" class="flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300">ğŸ‘¤ å€‹äººç”¨ (ç‰¹å®š)</button>
                                </div>
                            </div>
                            <div id="nfc-target-wrapper" class="hidden">
                                <label class="block text-xs font-bold text-indigo-600 mb-1">å¯¾è±¡è€… (å€‹äººç”¨ã®ã¿)</label>
                                <select id="nfc-target-name" class="w-full border border-indigo-200 rounded p-2 text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-indigo-600 mb-1">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»å ´æ‰€</label>
                                <select id="nfc-preset-location" class="w-full border border-indigo-200 rounded p-2 text-sm bg-white">
                                    <option value="present:407">ğŸ¢ 407 ã«åˆ°ç€ (åœ¨å®¤)</option>
                                    <option value="present:æ•™æˆå®¤">ğŸ—£ï¸ æ•™æˆå®¤ ã«åˆ°ç€ (åœ¨å®¤)</option>
                                    <option value="absent:-">ğŸ  å¸°å®…ã™ã‚‹ (ä¸åœ¨)</option>
                                </select>
                            </div>
                        </div>
                        <div class="bg-indigo-900 bg-opacity-5 rounded-lg p-4 border border-indigo-100 flex flex-col justify-between">
                            <div>
                                <label class="block text-xs font-bold text-indigo-800 mb-2">æ›¸ãè¾¼ã¿ç”¨URL</label>
                                <div class="bg-white p-3 rounded border border-indigo-200 break-all font-mono text-xs text-slate-600 mb-3 select-all" id="generated-url">https://...</div>
                            </div>
                            <button onclick="window.simulateNfcScan()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-sm shadow-md transition-colors"><i class="fa-solid fa-play mr-2"></i> ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç«¯æœ«ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° (ãƒ¢ãƒ¼ãƒ€ãƒ«) -->
        <div id="device-register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
                <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                    <h3 class="text-white font-bold text-lg"><i class="fa-solid fa-mobile-screen-button mr-2"></i>ç«¯æœ«è¨­å®š</h3>
                    <button onclick="window.closeRegisterModal()" class="text-blue-200 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="p-6">
                    <p class="text-sm text-slate-600 mb-4">
                        ã“ã®ç«¯æœ«ï¼ˆã‚¹ãƒãƒ›/PCï¼‰ã®æŒã¡ä¸»ã‚’è¨­å®šã—ã¾ã™ã€‚<br>
                        <span class="text-xs text-slate-400">â€»è¨­å®šã™ã‚‹ã¨ã€NFCã‚¿ã‚°ã‚’èª­ã¿å–ã£ãŸéš›ã«è‡ªå‹•ã§ã‚ãªãŸãŒèªè­˜ã•ã‚Œã¾ã™ã€‚</span>
                    </p>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ã‚ãªãŸã®åå‰</label>
                    <select id="modal-input-name" class="w-full border border-slate-300 rounded-lg p-2.5 mb-4 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    
                    <button onclick="window.submitRegisterDevice()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg shadow hover:bg-blue-700 transition-colors mb-2">
                        ç™»éŒ²ã™ã‚‹
                    </button>
                    <button onclick="window.clearRegisterDevice()" class="w-full bg-white text-red-500 border border-red-200 font-bold py-2 rounded-lg hover:bg-red-50 transition-colors text-sm">
                        è¨­å®šã‚’è§£é™¤ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- ç”»åƒãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="crop-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[110] flex flex-col justify-center items-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-slate-800 px-4 py-3 flex justify-between items-center text-white">
                    <h3 class="font-bold"><i class="fa-solid fa-crop-simple mr-2"></i>ç”»åƒã‚’åˆ‡ã‚ŠæŠœã</h3>
                    <button onclick="window.closeCropModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="flex-1 bg-black relative overflow-hidden min-h-[300px]">
                    <img id="crop-image" src="" alt="Crop" class="max-w-full block">
                </div>
                <div class="p-4 bg-white flex justify-end gap-3">
                    <button onclick="window.closeCropModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="window.saveCroppedImage()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow">åˆ‡ã‚ŠæŠœã</button>
                </div>
            </div>
        </div>

        <div class="mb-4 text-slate-600 text-sm font-medium flex items-center">
            <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
            ç¾åœ¨ã€ç ”ç©¶å®¤å‘¨è¾ºã« <span id="count-present" class="font-bold text-slate-900 text-lg mx-1">0</span> åãŒæ´»å‹•ä¸­ã§ã™
        </div>

        <div id="members-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
    </main>

    <div id="toast" class="toast">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ</div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, writeBatch, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2orsNpZqkfn4qor8SfS-AKjfelfov11A",
            authDomain: "lala-54834.firebaseapp.com",
            projectId: "lala-54834",
            storageBucket: "lala-54834.firebasestorage.app",
            messagingSenderId: "578411123082",
            appId: "1:578411123082:web:ec6e0637a5865e1aa3f873"
        };

        let db;
        let membersData = [];
        const COL_NAME = "members";

        // åˆæœŸåŒ–é–‹å§‹
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é–‹å§‹
            onSnapshot(collection(db, COL_NAME), (snapshot) => {
                const members = [];
                snapshot.forEach((doc) => members.push({ id: parseInt(doc.id), ...doc.data() }));

                if (members.length === 0) {
                    document.getElementById('setup-area').classList.remove('hidden');
                } else {
                    document.getElementById('setup-area').classList.add('hidden');
                    membersData = members;
                    renderMembers(); 
                    if(!window.urlParamsChecked) {
                        checkUrlParameters();
                        window.urlParamsChecked = true;
                    }
                }
                document.getElementById('loading-overlay').style.display = 'none';
            }, (error) => {
                console.error("Firestore read error:", error);
                document.getElementById('loading-overlay').style.display = 'none';
            });

        } catch (e) {
            console.error("Firebase init failed:", e);
            document.querySelector("#loading-overlay p").innerHTML = `<span class="text-red-500">è¨­å®šã‚¨ãƒ©ãƒ¼</span>`;
        }

        const iconPresets = [
            "fa-user", "fa-user-graduate", "fa-user-tie", "fa-user-astronaut", "fa-user-ninja", 
            "fa-cat", "fa-dog", "fa-crow", "fa-dragon", "fa-fish", "fa-hippo", "fa-otter", "fa-spider",
            "fa-robot", "fa-ghost", "fa-snowman", "fa-mug-hot", "fa-bicycle", "fa-car", "fa-plane",
            "fa-music", "fa-gamepad", "fa-futbol", "fa-book", "fa-microscope", "fa-glasses"
        ];

        const statusConfig = {
            present:    { label: "åœ¨å®¤", icon: "fa-laptop", cssClass: "status-present-bg", btnColor: "bg-green-100 text-green-700 hover:bg-green-200" },
            experiment: { label: "å®Ÿé¨“", icon: "fa-flask", cssClass: "status-experiment-bg", btnColor: "bg-yellow-100 text-yellow-700 hover:bg-yellow-200" },
            class:      { label: "æˆæ¥­", icon: "fa-book-open", cssClass: "status-class-bg", btnColor: "bg-blue-100 text-blue-700 hover:bg-blue-200" },
            meeting:    { label: "ä¼šè­°", icon: "fa-users", cssClass: "status-meeting-bg", btnColor: "bg-purple-100 text-purple-700 hover:bg-purple-200" },
            break:      { label: "ä¼‘æ†©", icon: "fa-mug-hot", cssClass: "status-experiment-bg", btnColor: "bg-orange-100 text-orange-700 hover:bg-orange-200" },
            absent:     { label: "å¸°å®…", icon: "fa-house", cssClass: "status-absent-bg", btnColor: "bg-slate-100 text-slate-600 hover:bg-slate-200" }
        };

        const defaultMembers = [
            { id: 1, name: "è¿‘è—¤ æ•™æˆ", role: "Professor", status: "absent", location: "-", icon: "fa-user-tie" },
            { id: 2, name: "å®®ä¸‹ å‡†æ•™æˆ", role: "Assoc. Prof", status: "absent", location: "-", icon: "fa-user-graduate" },
            { id: 3, name: "ä½è—¤ (M2)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 4, name: "é«˜ç¾½ (M2)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 5, name: "é‡æ‘ (M2)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 6, name: "æ£®ç”° (M2)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 7, name: "æ¨ªå±± (M2)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 8, name: "è¥¿ (M1)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 9, name: "æ±é‡ (M1)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 11, name: "å±±ä¸‹ (M1)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 12, name: "å°æŸ³ (M1)", role: "Master", status: "absent", location: "-", icon: "fa-user" },
            { id: 13, name: "æ¦æœ¬ (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
            { id: 14, name: "å º (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
            { id: 15, name: "é«˜æ©‹ (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
            { id: 16, name: "åŸ (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
            { id: 17, name: "å±±æœ¬ (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
            { id: 18, name: "å‰ç”° (B4)", role: "Bachelor", status: "absent", location: "-", icon: "fa-user" },
        ];

        let currentFilter = 'all';
        let nfcMode = 'shared';
        let activeCardId = null;
        let cropper;
        let currentEditMemberId = null;

        // --- Firestore Action Functions (Global) ---
        
        window.updateMemberFirestore = async (id, status, location, icon = null) => {
            if (!db) return;
            try {
                const now = getCurrentTime();
                const memberRef = doc(db, COL_NAME, id.toString());
                const data = { status, location, time: now, updatedAt: serverTimestamp() };
                if(icon) data.icon = icon;
                
                await updateDoc(memberRef, data);
                showToast(`æ›´æ–°ã—ã¾ã—ãŸ`);
                return true;
            } catch (e) {
                alert("æ›´æ–°å¤±æ•—: " + e.message); return false;
            }
        }

        window.initializeDB = async () => {
            if (!db || !confirm("åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const batch = writeBatch(db);
                defaultMembers.forEach(m => batch.set(doc(db, COL_NAME, m.id.toString()), { ...m, time: getCurrentTime() }));
                await batch.commit();
                alert("åˆæœŸåŒ–å®Œäº†ï¼");
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }
        document.getElementById('btn-initialize-db').addEventListener('click', window.initializeDB);

        // --- UI Logic ---
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function showToast(message) {
            const x = document.getElementById("toast");
            x.textContent = message;
            x.className = "toast show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        function enableDragScroll(el) {
            let isDown = false, startX, scrollLeft;
            el.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX - el.offsetLeft; scrollLeft = el.scrollLeft; e.stopPropagation(); });
            el.addEventListener('mouseleave', () => isDown = false);
            el.addEventListener('mouseup', (e) => { isDown = false; e.stopPropagation(); });
            el.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault(); e.stopPropagation();
                const x = e.pageX - el.offsetLeft;
                el.scrollLeft = scrollLeft - (x - startX) * 2;
            });
            el.addEventListener('touchstart', (e) => e.stopPropagation(), {passive: true});
            el.addEventListener('touchmove', (e) => e.stopPropagation(), {passive: true});
        }

        function resizeImage(file, maxWidth, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                    else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderMembers() {
            const grid = document.getElementById('members-grid');
            const nfcSelect = document.getElementById('nfc-target-name');
            const modalSelect = document.getElementById('modal-input-name');
            const myId = parseInt(localStorage.getItem('labApp_myId'));
            let myName = "æœªè¨­å®š";

            grid.innerHTML = '';
            nfcSelect.innerHTML = ''; 
            modalSelect.innerHTML = '<option value="" disabled selected>åå‰ã‚’é¸æŠ...</option>';

            let activeCount = 0;
            const sortedMembers = [...membersData].sort((a, b) => {
                const aAct = a.status !== 'absent', bAct = b.status !== 'absent';
                return aAct === bAct ? a.id - b.id : bAct - aAct;
            });

            sortedMembers.forEach(member => {
                const opt1 = document.createElement('option'); opt1.value = member.id; opt1.textContent = member.name;
                nfcSelect.appendChild(opt1);
                const opt2 = document.createElement('option'); opt2.value = member.id; opt2.textContent = member.name;
                modalSelect.appendChild(opt2);

                if (member.id === myId) myName = member.name;

                const isAbsent = member.status === 'absent';
                if (!((currentFilter === 'active' && isAbsent) || (currentFilter === 'absent' && !isAbsent))) {
                    if (!isAbsent) activeCount++;
                    const config = statusConfig[member.status] || statusConfig['absent'];
                    const isMe = member.id === myId;
                    
                    const rawIcon = member.icon || "fa-user";
                    const isImage = rawIcon.startsWith("data:image");
                    const iconHtml = isImage 
                        ? `<img src="${rawIcon}" class="w-full h-full object-cover rounded-full" alt="icon">`
                        : `<i class="fa-solid ${rawIcon}"></i>`;

                    const container = document.createElement('div');
                    container.className = `flip-container ${isMe ? 'is-me' : ''}`;
                    container.id = `card-${member.id}`;
                    container.setAttribute('onclick', `window.handleCardClick(${member.id})`);

                    const badge = isMe ? `<span class="absolute top-2 right-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold z-10">YOU</span>` : '';

                    let backContent = `
                        <div class="h-full flex flex-col p-3 relative">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="text-xs font-bold text-slate-400">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</h4>
                                <button onclick="event.stopPropagation(); window.flipCard(${member.id}, false)" class="text-slate-400 hover:text-slate-600 p-1"><i class="fa-solid fa-xmark text-lg"></i></button>
                            </div>
                            
                            <div class="mb-2">
                                <div class="grid grid-cols-3 gap-1">
                                    ${Object.keys(statusConfig).map(key => `
                                        <button onclick="event.stopPropagation(); window.selectStatus(${member.id}, '${key}')" class="py-1 rounded ${statusConfig[key].btnColor} text-[10px] font-bold transition-colors truncate">
                                            ${statusConfig[key].label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[10px] font-bold text-slate-300">ICON</span>
                                    <label class="cursor-pointer bg-slate-50 hover:bg-slate-100 px-2 py-0.5 rounded text-[10px] text-slate-500 flex items-center border border-slate-100 transition-colors" onclick="event.stopPropagation()">
                                        <i class="fa-solid fa-camera mr-1"></i> å¤‰æ›´
                                        <input type="file" class="hidden" accept="image/*" onchange="window.handleImageSelect(event, ${member.id})">
                                    </label>
                                </div>
                                <div class="icon-scroll flex gap-1.5 overflow-x-auto pb-1" onclick="event.stopPropagation()">
                                    ${iconPresets.map(icon => `
                                        <button onclick="window.selectIcon(${member.id}, '${icon}', this)" 
                                            class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 border ${rawIcon === icon ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-slate-100'} transition-all">
                                            <i class="fa-solid ${icon} text-xs"></i>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="mt-auto w-full flex items-center gap-2">
                                <input type="text" id="loc-input-${member.id}" placeholder="å ´æ‰€ãƒ¡ãƒ¢" class="flex-1 min-w-0 border border-slate-200 rounded px-2 py-1.5 text-xs outline-none focus:ring-2 focus:ring-blue-200 bg-slate-50" value="${member.location !== '-' ? member.location : ''}" onclick="event.stopPropagation()">
                                <button onclick="event.stopPropagation(); window.submitUpdate(${member.id})" class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded shadow-sm hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <i class="fa-solid fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    container.innerHTML = `
                        <div class="flip-card-inner">
                            <div class="flip-card-front ${config.cssClass} p-4">
                                <div class="relative h-full flex flex-col">
                                    ${badge}
                                    <div class="flex items-start space-x-3 mb-2">
                                        <div class="w-12 h-12 rounded-full flex-shrink-0 flex items-center justify-center bg-white bg-opacity-60 shadow-sm text-2xl text-slate-600 overflow-hidden">
                                            ${iconHtml}
                                        </div>
                                        <div class="flex-1 min-w-0 pt-1">
                                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-60 block leading-none mb-1">${member.role}</span>
                                            <h3 class="text-lg font-bold text-slate-800 leading-tight truncate">${member.name}</h3>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-1.5 mt-1">
                                        <div class="flex items-center justify-between bg-white bg-opacity-60 rounded px-3 py-1 shadow-sm"><span class="text-[10px] font-bold opacity-60">çŠ¶æ…‹</span><span class="text-sm font-bold flex items-center">${config.label}</span></div>
                                        <div class="flex items-center justify-between bg-white bg-opacity-60 rounded px-3 py-1 shadow-sm"><span class="text-[10px] font-bold opacity-60">å ´æ‰€</span><span class="text-sm font-medium truncate max-w-[100px] text-right">${member.location || '-'}</span></div>
                                    </div>
                                    <div class="mt-auto text-right"><span class="text-[10px] opacity-60 font-mono bg-white bg-opacity-40 px-1.5 py-0.5 rounded">${member.time}</span></div>
                                </div>
                            </div>
                            <div class="flip-card-back">${backContent}</div>
                        </div>
                    `;
                    grid.appendChild(container);
                    
                    const iconScrollDiv = container.querySelector('.icon-scroll');
                    if(iconScrollDiv) enableDragScroll(iconScrollDiv);
                }
            });

            document.getElementById('count-present').textContent = activeCount;
            
            const devInfo = document.getElementById('my-device-info');
            const devName = document.getElementById('my-device-name');
            if (myId) {
                devInfo.classList.remove('text-slate-500', 'hover:bg-slate-100');
                devInfo.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-100');
                devName.textContent = myName.split(" ")[0];
            } else {
                devInfo.classList.add('text-slate-500', 'hover:bg-slate-100');
                devInfo.classList.remove('text-blue-600', 'bg-blue-50', 'border-blue-100');
                devName.textContent = "æœªè¨­å®š";
            }
        }

        // --- Card Interaction ---
        window.handleCardClick = (id) => { window.flipCard(id, true); };

        window.flipCard = (id, isFlipped) => {
            if (isFlipped && activeCardId && activeCardId !== id) {
                document.getElementById(`card-${activeCardId}`)?.classList.remove('is-flipped');
            }
            const card = document.getElementById(`card-${id}`);
            if (card) {
                isFlipped ? card.classList.add('is-flipped') : card.classList.remove('is-flipped');
                activeCardId = isFlipped ? id : null;
            }
        };

        window.selectStatus = (id, statusKey) => {
            let loc = document.getElementById(`loc-input-${id}`).value;
            if (statusKey === 'absent') {
                loc = "-";
            } else if (!loc || loc === '-' || loc === 'ç ”ç©¶å®¤' || loc === 'å®Ÿé¨“å®¤' || loc === 'è¬›ç¾©æ£Ÿ' || loc === 'å­¦å†…') {
                if (statusKey === 'present') loc = "ç ”ç©¶å®¤";
                else if (statusKey === 'experiment') loc = "å®Ÿé¨“å®¤";
                else if (statusKey === 'class') loc = "è¬›ç¾©æ£Ÿ";
                else loc = "å­¦å†…";
            }
            document.getElementById(`loc-input-${id}`).value = loc;
            window.updateMemberFirestore(id, statusKey, loc).then(success => {
                if(success) window.flipCard(id, false);
            });
        };

        window.selectIcon = (id, iconClass, btnElement) => {
            const parent = btnElement.parentNode;
            Array.from(parent.children).forEach(c => {
                c.className = "flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 border border-slate-100 transition-all";
            });
            btnElement.className = "flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-blue-600 bg-blue-50 border border-blue-500 transition-all";
            document.getElementById(`loc-input-${id}`).dataset.selectedIcon = iconClass;
        };

        // --- Image Upload & Crop Logic ---
        window.handleImageSelect = (event, id) => {
            const file = event.target.files[0];
            if (!file) return;
            
            currentEditMemberId = id;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageElement = document.getElementById('crop-image');
                imageElement.src = e.target.result;
                document.getElementById('crop-modal').classList.remove('hidden');
                
                if(cropper) cropper.destroy();
                cropper = new Cropper(imageElement, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        };

        window.saveCroppedImage = () => {
            if(!cropper || !currentEditMemberId) return;
            const canvas = cropper.getCroppedCanvas({ width: 128, height: 128, imageSmoothingQuality: 'high' });
            const base64Data = canvas.toDataURL('image/jpeg', 0.8);
            
            const input = document.getElementById(`loc-input-${currentEditMemberId}`);
            if(input) {
                input.dataset.selectedIcon = base64Data;
                const container = input.closest('.flip-card-back');
                const iconButtons = container.querySelectorAll('.icon-scroll button');
                iconButtons.forEach(btn => btn.className = "flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-100 border border-slate-100 transition-all");
                showToast("ç”»åƒã‚’åˆ‡ã‚ŠæŠœãã¾ã—ãŸï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ã§ä¿å­˜ï¼‰");
            }
            window.closeCropModal();
        };

        window.closeCropModal = () => {
            document.getElementById('crop-modal').classList.add('hidden');
            if(cropper) { cropper.destroy(); cropper = null; }
        };

        window.submitUpdate = (id) => {
            const member = membersData.find(m => m.id === id);
            const loc = document.getElementById(`loc-input-${id}`).value;
            const newIcon = document.getElementById(`loc-input-${id}`).dataset.selectedIcon || member.icon;
            window.updateMemberFirestore(id, member.status, loc, newIcon).then(success => {
                if(success) window.flipCard(id, false);
            });
        };

        // --- Device Registration Modal ---
        window.promptRegisterDevice = () => {
            const modal = document.getElementById('device-register-modal');
            const myId = parseInt(localStorage.getItem('labApp_myId'));
            if(myId) document.getElementById('modal-input-name').value = myId;
            modal.classList.remove('hidden');
        };
        window.closeRegisterModal = () => { document.getElementById('device-register-modal').classList.add('hidden'); };
        window.submitRegisterDevice = () => {
            const id = document.getElementById('modal-input-name').value;
            if(!id) return alert("åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
            localStorage.setItem('labApp_myId', id);
            alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
            window.closeRegisterModal();
            renderMembers();
        };
        window.clearRegisterDevice = () => {
            if(confirm("è¨­å®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('labApp_myId');
                window.closeRegisterModal();
                renderMembers();
            }
        };

        // --- NFC / Others ---
        window.toggleNfcPanel = () => { document.getElementById('nfc-panel').classList.toggle('hidden'); window.updateNfcUrl(); };
        window.setFilter = (filterType) => {
            currentFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow');
                btn.classList.add('text-slate-500', 'hover:bg-slate-100');
            });
            document.getElementById('filter-' + filterType).classList.remove('text-slate-500', 'hover:bg-slate-100');
            document.getElementById('filter-' + filterType).classList.add('bg-blue-600', 'text-white', 'shadow');
            renderMembers();
        };
        window.setNfcMode = (mode) => {
            nfcMode = mode;
            document.getElementById('nfc-target-wrapper').classList.toggle('hidden', mode === 'shared');
            document.getElementById('btn-mode-shared').className = mode==='shared' ? "flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600" : "flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300";
            document.getElementById('btn-mode-personal').className = mode==='personal' ? "flex-1 py-2 px-3 rounded border text-sm font-bold bg-indigo-600 text-white border-indigo-600" : "flex-1 py-2 px-3 rounded border text-sm font-bold bg-white text-indigo-600 border-indigo-300";
            window.updateNfcUrl();
        };
        window.updateNfcUrl = () => {
            const memberId = document.getElementById('nfc-target-name').value;
            const preset = document.getElementById('nfc-preset-location').value || "";
            const [status, location] = preset.split(':');
            const baseUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            let params = `?status=${status}&loc=${encodeURIComponent(location || "")}`;
            if (nfcMode === 'personal' && memberId) params += `&nfc_id=${memberId}`;
            document.getElementById('generated-url').textContent = baseUrl + params;
        };
        document.getElementById('nfc-target-name').addEventListener('change', window.updateNfcUrl);
        document.getElementById('nfc-preset-location').addEventListener('change', window.updateNfcUrl);
        window.simulateNfcScan = () => {
            const urlText = document.getElementById('generated-url').textContent;
            try { const url = new URL(urlText); checkUrlParameters(new URLSearchParams(url.search)); } catch(e) { console.error(e); }
        };
        async function checkUrlParameters(params = null) {
            const searchParams = params || new URLSearchParams(window.location.search);
            if (!searchParams.has('status') || !searchParams.has('loc')) return;
            const status = searchParams.get('status');
            const loc = searchParams.get('loc');
            let targetId = null;
            if (searchParams.has('nfc_id')) targetId = parseInt(searchParams.get('nfc_id'));
            else {
                targetId = parseInt(localStorage.getItem('labApp_myId'));
                if (!targetId && !params) { alert("ã€å…±æœ‰ã‚¿ã‚°æ¤œçŸ¥ã€‘\nã¾ã ç«¯æœ«è¨­å®šãŒã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
            }
            if (targetId) {
                await updateMemberFirestore(targetId, status, loc);
                if (!params) {
                    const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({path: newUrl}, '', newUrl);
                }
            }
        }

        setInterval(() => { document.getElementById('current-clock').textContent = getCurrentTime(); }, 1000);
        document.getElementById('current-clock').textContent = getCurrentTime();
        setTimeout(() => window.updateNfcUrl(), 1000);
    </script>
</body>
</html>